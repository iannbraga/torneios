<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Gerenciador de Torneios de Xadrez – Sistema Suíço</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />

  <!-- Vue 3 -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
</head>
<body class="bg-light">

<div id="app" class="container py-4">
  <h1 class="mb-4">Gerenciador de Torneios de Xadrez (Sistema Suíço)</h1>

  <!-- Configuração do Torneio -->
  <div class="card mb-4">
    <div class="card-body">
      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label">Nome do Torneio</label>
          <input v-model="tournament.name" type="text" class="form-control" />
        </div>

        <div class="col-md-3">
          <label class="form-label">Tempo de Jogo</label>
          <select v-model="tournament.timeControl" class="form-select">
            <option>Clássicas</option>
            <option>Rápidas</option>
            <option>Blitz</option>
          </select>
        </div>

        <div class="col-md-3">
          <label class="form-label">Rodadas</label>
          <input v-model.number="tournament.rounds" type="number" min="1" class="form-control" />
        </div>

        <div class="col-12">
          <label class="form-label">Participantes (1 por linha)</label>
          <textarea v-model="participantsText" class="form-control" rows="4"></textarea>
        </div>
      </div>

      <div class="mt-3 d-flex gap-2">
        <button @click="startTournament" class="btn btn-primary">Iniciar Torneio</button>
        <button @click="exportCSV" class="btn btn-outline-secondary">Exportar CSV</button>
        <button @click="resetTournament" class="btn btn-outline-danger">Resetar</button>
      </div>
    </div>
  </div>

  <!-- Rodadas -->
  <div v-for="(round, rIndex) in rounds" :key="rIndex" class="card mb-3">
    <div class="card-body">
      <h4>Rodada {{ rIndex + 1 }}</h4>

      <table class="table">
        <thead>
          <tr>
            <th>Brancas</th>
            <th>Pretas</th>
            <th>Resultado</th>
          </tr>
        </thead>
        <tbody>
          <tr v-for="(game, gIndex) in round.games" :key="gIndex">
            <td>{{ game.white }}</td>
            <td>{{ game.black }}</td>
            <td v-if="!game.bye">
              <select v-model="game.result" @change="applyResult(game)" class="form-select">
                <option value="">—</option>
                <option value="1-0">1–0</option>
                <option value="0-1">0–1</option>
                <option value="0.5-0.5">½–½</option>
              </select>
            </td>
            <td v-else>
              Bye (1 ponto)
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Classificação -->
  <div v-if="players.length" class="card">
    <div class="card-body">
      <h4>Classificação</h4>
      <table class="table table-striped">
        <thead>
          <tr>
            <th>#</th>
            <th>Jogador</th>
            <th>Pontos</th>
          </tr>
        </thead>
        <tbody>
          <tr v-for="(p, i) in sortedPlayers" :key="p.name">
            <td>{{ i + 1 }}</td>
            <td>{{ p.name }}</td>
            <td>{{ p.points }}</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
const { createApp } = Vue;

createApp({
  data() {
    return {
      tournament: {
        name: '',
        timeControl: 'Rápidas',
        rounds: 1
      },
      participantsText: '',
      players: [],
      rounds: []
    }
  },
  computed: {
    sortedPlayers() {
      return [...this.players].sort((a, b) => b.points - a.points);
    }
  },
  methods: {
    startTournament() {
      this.players = this.participantsText
        .split('\n')
        .map(p => p.trim())
        .filter(p => p)
        .map(p => ({ name: p, points: 0, hadBye: false }));

      this.rounds = [];
      this.generateNextRound();
      this.save();
    },

    generateNextRound() {
      const roundIndex = this.rounds.length;
      if (roundIndex >= this.tournament.rounds) return;

      const sorted = [...this.players].sort((a, b) => b.points - a.points);
      const used = new Set();
      const games = [];

      // Bye automático
      if (sorted.length % 2 === 1) {
        const byePlayer = sorted.find(p => !p.hadBye);
        byePlayer.points += 1;
        byePlayer.hadBye = true;
        used.add(byePlayer.name);
        games.push({ white: byePlayer.name, black: '—', bye: true });
      }

      for (let i = 0; i < sorted.length; i++) {
        if (used.has(sorted[i].name)) continue;

        for (let j = i + 1; j < sorted.length; j++) {
          if (!used.has(sorted[j].name)) {
            used.add(sorted[i].name);
            used.add(sorted[j].name);
            games.push({ white: sorted[i].name, black: sorted[j].name, result: '', bye: false });
            break;
          }
        }
      }

      this.rounds.push({ games });
      this.save();
    },

    applyResult(game) {
      if (game._applied) return;

      const white = this.players.find(p => p.name === game.white);
      const black = this.players.find(p => p.name === game.black);

      if (game.result === '1-0') white.points += 1;
      if (game.result === '0-1') black.points += 1;
      if (game.result === '0.5-0.5') {
        white.points += 0.5;
        black.points += 0.5;
      }

      game._applied = true;

      const currentRound = this.rounds[this.rounds.length - 1];
      const allFinished = currentRound.games
        .filter(g => !g.bye)
        .every(g => g.result);

      if (allFinished) {
        this.generateNextRound();
      }

      this.save();
    },

    exportCSV() {
      let csv = 'Rodada,Brancas,Pretas,Resultado\n';
      this.rounds.forEach((r, i) => {
        r.games.forEach(g => {
          csv += `${i + 1},${g.white},${g.black},${g.result || 'BYE'}\n`;
        });
      });

      const blob = new Blob([csv], { type: 'text/csv' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `${this.tournament.name || 'torneio'}.csv`;
      link.click();
    },

    save() {
      localStorage.setItem('chessTournament', JSON.stringify({
        tournament: this.tournament,
        players: this.players,
        rounds: this.rounds,
        participantsText: this.participantsText
      }));
    },

    load() {
      const data = localStorage.getItem('chessTournament');
      if (!data) return;
      const parsed = JSON.parse(data);
      Object.assign(this.$data, parsed);
    },

    resetTournament() {
      localStorage.removeItem('chessTournament');
      location.reload();
    }
  },
  mounted() {
    this.load();
  }
}).mount('#app');
</script>

</body>
</html>
